<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login + Gerador de Certificados (PDF) ‚Äî 1 arquivo</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#93a2c8;
      --ink:#e8eefc;
      --accent:#5aa1ff;
      --ok:#61d095;
      --warn:#f6c350;
    }
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; 
      color:var(--ink); background:radial-gradient(1200px 800px at 20% -10%, #1e2a55 0, #121a33 35%, #0b1020 70%);
    }

    /* ---------- Tela de Login ---------- */
    #loginScreen{
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .login-card{
      background:var(--card);
      border:1px solid #1e2950;
      border-radius:16px;
      padding:28px;
      width:min(92vw,360px);
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      text-align:center;
    }
    .login-card h2{margin:0 0 6px}
    .login-card p.sub{font-size:14px; color:#a7b6e2; margin:0 0 16px}
    .field{margin-bottom:12px; text-align:left}
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .field input{
      width:100%; padding:12px; border-radius:10px; border:1px solid #20305f;
      background:#0d1530; color:var(--ink); outline:none; font-size:15px;
    }
    .row{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .row small{color:#a7b6e2}
    .btn{
      appearance:none; border:1px solid #31457f; background:#0e1a3b; color:var(--ink);
      padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:600; width:100%;
    }
    .btn.primary{background:linear-gradient(180deg, #5aa1ff, #3d7ee0); color:#081024; border:none}
    #loginMsg{color:var(--warn); font-size:13px; margin-top:10px; min-height:18px}

    /* ---------- App (gerador) ---------- */
    .container{max-width:1100px; margin:32px auto; padding:0 16px;}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px}
    header h1{font-size:22px; font-weight:700; margin:0}
    .card{background:var(--card); border:1px solid #1e2950; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.25);}
    .grid{display:grid; gap:16px}
    .grid.cols-2{grid-template-columns: 1fr 1fr}
    .grid.cols-3{grid-template-columns: 1fr 1fr 1fr}
    .section{padding:20px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input[type="text"], input[type="date"], textarea{ width:100%; box-sizing:border-box; background:#0d1530; color:var(--ink); border:1px solid #20305f; border-radius:10px; padding:12px 12px; outline:none }
    textarea{min-height:160px; resize:vertical}
    .hint{font-size:12px; color:#a7b6e2; margin-top:6px}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    button{appearance:none; border:1px solid #31457f; background:#0e1a3b; color:var(--ink); padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:600}
    button.primary{background:linear-gradient(180deg, #5aa1ff, #3d7ee0); color:#081024; border: none}
    button.success{background:linear-gradient(180deg, #61d095, #2fb677); border:none; color:#061913}
    button.ghost{background:transparent}
    input[type="file"]{color:var(--muted)}
    .pill{font-size:12px; border:1px dashed #2d427f; color:#a1b2e5; padding:6px 10px; border-radius:999px}

    #printArea{display:none;}
    .cert{
      position:relative; box-sizing:border-box; width:297mm; height:210mm; 
      padding:18mm; background: #fcfdff; color:#0c1a3c; font-family: "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-after: always;
    }
    .cert .bg{
      position:absolute; inset:12mm; border:5px double #0e2c62; border-radius:12mm; box-shadow: inset 0 0 0 10mm rgba(20,54,124,0.02);
    }
    .cert .orn{position:absolute; inset:0; pointer-events:none;}
    .cert .brand{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .brand .left{display:flex; align-items:center; gap:12px}
    .brand .logo{width:56px; height:56px; object-fit:contain}
    .brand .evt{font-weight:800; letter-spacing:.6px; font-size:18px; color:#0e2c62}
    .cert h1{margin:18mm 0 4mm; text-align:center; font-size:30px; letter-spacing:.8px; color:#0a1e4a}
    .cert p{margin:8px 0; font-size:15.5px; color:#0f2559}
    .cert .bigname{font-size:26px; font-weight:800; text-align:center; margin:10px 0 2px; color:#0a1e4a}
    .cert .center{text-align:center}
    .muted{color:#415a98}
    .meta{display:flex; gap:24px; justify-content:center; margin-top:20px; font-size:14px; color:#16306b}
    .signrow{display:flex; justify-content:space-between; align-items:flex-end; gap:24px; margin-top:26mm}
    .sign{flex:1; text-align:center}
    .sign .line{border-top:1.6px solid #0e2c62; margin-top:8mm}
    .sign img{max-height:44px; max-width:240px; object-fit:contain}
    .qr{position:absolute; right:18mm; bottom:18mm; font-size:10px; color:#3656a5}
    .small{font-size:12px}

    @media print{
      body{background:white}
      #loginScreen{display:none !important}
      .container, header{display:none !important}
      #printArea{display:block}
    }

    table.part{width:100%; border-collapse:collapse; margin-top:8px; font-size:14px}
    table.part th, table.part td{border:1px solid #263a72; padding:8px 10px}
    table.part th{background:#0f1b3c; color:#cfe0ff; text-align:left}

    /* Esconde o app at√© logar */
    #app{display:none}
  </style>
</head>
<body>

  <!-- TELA DE LOGIN -->
  <section id="loginScreen">
    <div class="login-card">
      <h2>üîí Acesso Restrito</h2>
      <p class="sub">Entre para gerar certificados</p>

      <div class="field">
        <label for="loginUser">Usu√°rio</label>
        <input id="loginUser" type="text" placeholder="nome" autocomplete="username" />
      </div>
      <div class="field">
        <label for="loginPass">Senha</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>

      <div class="row" style="margin:8px 0 14px">
        <label style="display:flex; gap:8px; align-items:center; cursor:pointer">
          <input type="checkbox" id="remember" />
          <span>Manter conectado</span>
        </label>
        <small>Dica: usu√°rio e senha s√£o <b>leandro</b></small>
      </div>

      <button class="btn primary" id="btnLogin">Entrar</button>
      <div id="loginMsg"></div>
    </div>
  </section>

  <!-- APP (GERADOR) -->
  <section id="app" aria-hidden="true">
    <div class="container">
      <header>
        <h1>üéì Gerador de Certificados (um √∫nico arquivo)</h1>
        <div style="display:flex; align-items:center; gap:8px">
          <span class="pill">A4 ‚Ä¢ Paisagem ‚Ä¢ Salvar como PDF</span>
          <button id="btnLogout" class="ghost" title="Encerrar sess√£o">Sair</button>
        </div>
      </header>

      <div class="card section">
        <div class="grid cols-2">
          <div>
            <label for="evento">Nome do evento</label>
            <input id="evento" type="text" placeholder="Ex.: Latinoware ‚Äì Confer√™ncia Latino-Americana de Software Livre e Tecnologias Abertas" />
          </div>
          <div>
            <label for="subtitulo">Descri√ß√£o/tema (opcional)</label>
            <input id="subtitulo" type="text" placeholder="Ex.: Trilha de Inova√ß√£o e Educa√ß√£o Tecnol√≥gica" />
          </div>
          <div>
            <label for="data">Data do evento</label>
            <input id="data" type="date" />
            <div class="hint">Usado no corpo do certificado (formato por extenso).</div>
          </div>
          <div>
            <label for="local">Local</label>
            <input id="local" type="text" placeholder="Ex.: Parque Tecnol√≥gico Itaipu (PTI), Foz do Igua√ßu ‚Äì PR" />
          </div>
          <div>
            <label for="emissor">Assinante (nome)</label>
            <input id="emissor" type="text" placeholder="Ex.: Prof. Leonardo Gomes Guidolin" />
          </div>
          <div>
            <label for="cargo">Assinante (cargo/entidade)</label>
            <input id="cargo" type="text" placeholder="Ex.: Coordenador do Curso de Engenharia de Software ‚Äî Faculdade Unigua√ßu" />
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:14px">
          <div>
            <label for="logo">Logomarca (opcional)</label>
            <input id="logo" type="file" accept="image/*" />
            <div class="hint">PNG com fundo transparente fica excelente.</div>
          </div>
          <div>
            <label for="assinatura">Assinatura digital (opcional)</label>
            <input id="assinatura" type="file" accept="image/*" />
            <div class="hint">Imagem da assinatura para aparecer acima da linha.</div>
          </div>
        </div>
      </div>

      <div class="card section" style="margin-top:16px">
        <label for="participantes">Participantes (um por linha): <span class="muted">Nome; Horas</span></label>
        <textarea id="participantes" placeholder="Exemplos:
Mateus Alessandro Sulzbach; 8
Ana Paula Ferreira; 4.5
Jo√£o da Silva; 10"></textarea>
        <details style="margin-top:10px">
          <summary class="muted">Ver como tabela (opcional)</summary>
          <div class="hint">Voc√™ pode colar em massa; a tabela √© apenas visual.</div>
          <table class="part" id="previewTable"><thead><tr><th>#</th><th>Nome</th><th>Horas</th></tr></thead><tbody></tbody></table>
        </details>
        <div class="btns">
          <button id="btnPreview">Pr√©-visualizar certificados</button>
          <button id="btnPDF" class="primary">Gerar PDF (Imprimir)</button>
          <button id="btnDemo" class="ghost">Preencher com exemplo</button>
        </div>
        <div class="hint">Dica: ap√≥s clicar em <b>Gerar PDF</b>, escolha "Salvar como PDF" no di√°logo de impress√£o. O layout j√° est√° no tamanho A4 Paisagem com quebras de p√°gina.</div>
      </div>
    </div>

    <div id="printArea"></div>
  </section>

  <script>
    // ---------- LOGIN ----------
    const LOGIN_USER = 'leandro';
    const LOGIN_PASS = 'leandro';
    const KEY = 'certapp.auth';

    const $ = (sel) => document.querySelector(sel);

    function showApp(){
      $('#loginScreen').style.display = 'none';
      const app = $('#app');
      app.style.display = 'block';
      app.setAttribute('aria-hidden', 'false');
    }
    function showLogin(){
      $('#app').style.display = 'none';
      $('#loginScreen').style.display = 'flex';
    }
    function loginOk(){
      localStorage.setItem(KEY, JSON.stringify({ts: Date.now()}));
      showApp();
    }
    function isLogged(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return false;
        const {ts} = JSON.parse(raw);
        // sess√£o expira em 7 dias
        return ts && (Date.now() - ts) < 7*24*60*60*1000;
      }catch(e){ return false; }
    }
    function logout(){
      localStorage.removeItem(KEY);
      showLogin();
    }

    $('#btnLogin').addEventListener('click', ()=>{
      const u = $('#loginUser').value.trim();
      const p = $('#loginPass').value.trim();
      if(u===LOGIN_USER && p===LOGIN_PASS){
        if($('#remember').checked){ loginOk(); }
        else { sessionStorage.setItem(KEY, '1'); showApp(); }
        $('#loginMsg').textContent = '';
      } else {
        $('#loginMsg').textContent = 'Usu√°rio ou senha incorretos.';
      }
    });

    // Enter para enviar
    $('#loginPass').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('#btnLogin').click(); });

    // Restaura sess√£o
    if(isLogged() || sessionStorage.getItem(KEY)==='1'){ showApp(); }

    // Logout
    $('#btnLogout')?.addEventListener('click', ()=>{ sessionStorage.removeItem(KEY); logout(); });


    // ---------- GERADOR (seu c√≥digo original) ----------
    function sanitize(str){
      return String(str||"")
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }

    function parseHoras(s){
      if(s==null) return null;
      const t = String(s).trim().replace(',', '.');
      const v = parseFloat(t);
      return Number.isFinite(v) && v>=0 ? v : null;
    }

    function parseParticipantes(raw){
      const linhas = String(raw||"").split(/\n+/);
      const out = [];
      for(const ln of linhas){
        const clean = ln.trim();
        if(!clean) continue;
        const parts = clean.split(/\s*[;|,\t]\s*/);
        const nomeBruto = parts[0]?.trim();
        const nome = nomeBruto ? nomeBruto.toUpperCase() : ''; // UPPER aplicado aqui
        const horas = parseHoras(parts[1]);
        if(!nome){ continue; }
        if(horas==null){
          out.push({nome, horas:null, erro:"Horas ausentes/inv√°lidas"});
        } else {
          out.push({nome, horas});
        }
      }
      return out;
    }

    function fmtDateLong(iso){
      if(!iso) return '';
      const d = new Date(iso + 'T12:00:00');
      if(!(d instanceof Date) || isNaN(d)) return '';
      const meses = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
      return `${d.getDate()} de ${meses[d.getMonth()]} de ${d.getFullYear()}`;
    }

    async function fileToDataURL(input){
      return new Promise((resolve)=>{
        const f = input?.files?.[0];
        if(!f){ resolve(null); return; }
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.readAsDataURL(f);
      });
    }

    function refreshTable(){
      const tb = $('#previewTable tbody');
      tb.innerHTML = '';
      const list = parseParticipantes($('#participantes').value);
      list.forEach((p, i)=>{
        const row = document.createElement('tr');
        row.innerHTML = `<td>${i+1}</td><td>${sanitize(p.nome)}${p.erro?`<br><small style="color:#ffce6a">${p.erro}</small>`:''}</td><td>${p.horas ?? '‚Äî'}</td>`;
        tb.appendChild(row);
      });
    }

    function buildCertificateHTML({evt, subt, dataExt, local, emissor, cargo, nome, horas, logoURL, signURL, idx}){
      const nomeSafe = sanitize(nome);
      const evtSafe = sanitize(evt);
      const subtSafe = sanitize(subt);
      const localSafe = sanitize(local);
      const emissorSafe = sanitize(emissor);
      const cargoSafe = sanitize(cargo);
      const textoSub = subtSafe ? `<div class="center muted" style="margin-top:2px">${subtSafe}</div>` : '';
      const logoImg = logoURL ? `<img class="logo" src="${logoURL}" alt="logo"/>` : '';
      const signImg = signURL ? `<img src="${signURL}" alt="assinatura"/>` : '';
      const hoje = new Date();
      const serial = String(hoje.getFullYear()).slice(-2) + String(hoje.getMonth()+1).padStart(2,'0') + String(idx).padStart(4,'0');

      return `
      <section class="cert">
        <div class="bg"></div>
        <div class="orn"></div>
        <div class="brand">
          <div class="left">${logoImg}<div class="evt">${evtSafe}</div></div>
          <div class="right small muted">N¬∫ ${serial}</div>
        </div>
        <h1>CERTIFICADO</h1>
        ${textoSub}
        <p class="center" style="margin-top:12px">Certificamos que</p>
        <div class="bigname">${nomeSafe}</div>
        <p class="center">participou do evento <b>${evtSafe}</b>${subtSafe?", ":""}${subtSafe?`<span class="muted">${subtSafe}</span>`:""}, realizado em ${localSafe}, no dia ${dataExt}, totalizando <b>${horas}</b> hora${horas==1?'':'s'} de atividades.</p>
        <div class="meta">
          <div><b>Local:</b> ${localSafe}</div>
          <div><b>Data:</b> ${dataExt}</div>
          <div><b>Carga hor√°ria:</b> ${horas}h</div>
        </div>
        <div class="signrow">
          <div class="sign">
            ${signImg}
            <div class="line"></div>
            <div><b>${emissorSafe}</b></div>
            <div class="muted small">${cargoSafe}</div>
          </div>
        </div>
        <div class="qr">Documento emitido em ${hoje.toLocaleDateString('pt-BR')} ¬∑ ${window.location.href}</div>
      </section>`;
    }

    async function renderCerts({triggerPrint=false}){
      const evt = $('#evento').value.trim();
      const subt = $('#subtitulo').value.trim();
      const dataExt = fmtDateLong($('#data').value);
      const local = $('#local').value.trim();
      const emissor = $('#emissor').value.trim();
      const cargo = $('#cargo').value.trim();
      const participantes = parseParticipantes($('#participantes').value);

      const errors = [];
      if(!evt) errors.push('Informe o nome do evento.');
      if(!dataExt) errors.push('Selecione a data do evento.');
      if(!local) errors.push('Informe o local.');
      if(!emissor) errors.push('Informe o nome do assinante.');
      if(!cargo) errors.push('Informe o cargo/entidade do assinante.');
      if(!participantes.length) errors.push('Adicione pelo menos um participante.');
      const invalid = participantes.filter(p=>p.horas==null);
      if(invalid.length) errors.push(`H√° ${invalid.length} participante(s) com horas inv√°lidas.`);

      if(errors.length){
        alert('Corrija antes de continuar:\n\n‚Ä¢ ' + errors.join('\n‚Ä¢ '));
        return;
      }

      const logoURL = await fileToDataURL($('#logo'));
      const signURL = await fileToDataURL($('#assinatura'));

      const area = $('#printArea');
      area.innerHTML = participantes.map((p, i)=> buildCertificateHTML({evt, subt, dataExt, local, emissor, cargo, nome:p.nome, horas:p.horas, logoURL, signURL, idx:i+1})).join('\n');

      if(triggerPrint){
        setTimeout(()=>window.print(), 150);
      }
    }

    // Bind bot√µes do app (somente se o app existe no DOM)
    $('#btnPreview')?.addEventListener('click', ()=> renderCerts({triggerPrint:false}));
    $('#btnPDF')?.addEventListener('click', ()=> renderCerts({triggerPrint:true}));
    $('#participantes')?.addEventListener('input', refreshTable);
    $('#btnDemo')?.addEventListener('click', ()=>{
      $('#evento').value = 'Latinoware ‚Äì Confer√™ncia Latino-Americana de Software Livre e Tecnologias Abertas';
      $('#subtitulo').value = 'Trilha de Inova√ß√£o e Educa√ß√£o Tecnol√≥gica';
      $('#data').value = new Date().toISOString().slice(0,10);
      $('#local').value = 'Parque Tecnol√≥gico Itaipu (PTI), Foz do Igua√ßu ‚Äì PR';
      $('#emissor').value = 'Prof. Leonardo Gomes Guidolin';
      $('#cargo').value = 'Coordenador do Curso de Engenharia de Software ‚Äî Faculdade Unigua√ßu';
      $('#participantes').value = 'Mateus Alessandro Sulzbach; 8\nAna Paula Ferreira; 4.5\nJo√£o da Silva; 10';
      refreshTable();
    });

    // Inicializa preview vazio
    refreshTable();
  </script>
</body>
</html>
